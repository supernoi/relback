{% extends 'base.html' %}
{% load static %}

{% block title %}RelBack - Backup Policies{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="page-title">Backup Policies Management</h1>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ policies|length }}</div>
                <div class="stats-label">Total Policies</div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="modern-card">
                <div class="modern-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Quick Actions</h5>
                            <p class="text-muted mb-0">Manage your backup policies efficiently</p>
                        </div>
                        <button type="button" class="btn btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#modalAddNew">
                            <i class="bi bi-plus-circle me-2"></i>Add New Policy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer"></div>

    <!-- Policies Table -->
    <div class="modern-card">
        <div class="modern-card-body">
            <div class="table-responsive">
                <table class="table table-modern" id="policyTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Policy Name</th>
                            <th>Client</th>
                            <th>Hostname</th>
                            <th>Database</th>
                            <th>Backup Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in policies %}
                        <tr id="policy-{{ p.id_policy }}">
                            <td>{{ p.id_policy }}</td>
                            <td class="policyName">{{ p.policy_name }}</td>
                            <td class="policyClientName">{{ p.client.name }}</td>
                            <td class="policyHostname">{{ p.host.hostname }}</td>
                            <td class="policyDbName">{{ p.database.db_name }}</td>
                            <td>
                                <span class="badge bg-info">{{ p.backup_type }}</span>
                            </td>
                            <td>
                                {% if p.status == 'ACTIVE' %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-modern btn-modern-outline" 
                                            title="View Details" 
                                            onclick="policyDetail({{ p.id_policy }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-modern btn-modern-primary" 
                                            title="Edit" 
                                            onclick="policyUpdate({{ p.id_policy }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-modern btn-modern-danger" 
                                            title="Delete" 
                                            onclick="policyModalDelete({{ p.id_policy }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                            
                            <!-- Hidden fields for JavaScript -->
                            <input type="hidden" class="policyClientId" value="{{ p.client.id_client }}">
                            <input type="hidden" class="policyHostId" value="{{ p.host.id_host }}">
                            <input type="hidden" class="policyDatabaseId" value="{{ p.database.id_database }}">
                            <input type="hidden" class="policyDestination" value="{{ p.destination }}">
                            <input type="hidden" class="policyDuration" value="{{ p.duration }}">
                            <input type="hidden" class="policySizeBackup" value="{{ p.size_backup }}">
                            <input type="hidden" class="policyMinute" value="{{ p.minute }}">
                            <input type="hidden" class="policyHour" value="{{ p.hour }}">
                            <input type="hidden" class="policyDay" value="{{ p.day }}">
                            <input type="hidden" class="policyDayWeek" value="{{ p.day_week }}">
                            <input type="hidden" class="policyMonth" value="{{ p.month }}">
                            <input type="hidden" class="policyDescription" value="{{ p.description }}">
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="bi bi-shield-exclamation" style="font-size: 3rem; color: #6c757d;"></i>
                                    <h5 class="mt-3 text-muted">No backup policies found</h5>
                                    <p class="text-muted">Create your first backup policy to get started.</p>
                                    <button type="button" class="btn btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#modalAddNew">
                                        <i class="bi bi-plus-circle me-2"></i>Add First Policy
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add New Policy -->
<div class="modal fade" id="modalAddNew" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content modal-modern">
            <div class="modal-header modern-card-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>New Backup Policy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="policyFormCreate" method="post" action="{% url 'coreRelback:policyCreate' %}">
                <div class="modal-body modern-card-body">
                    {% csrf_token %}
                    
                    <!-- Basic Info -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateStatus" name="status" required>
                                    <option value="ACTIVE" selected>Active</option>
                                    <option value="INACTIVE">Inactive</option>
                                </select>
                                <label for="policyCreateStatus">Status</label>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateName" name="policy_name" required>
                                <label for="policyCreateName">Policy Name</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Infrastructure Selection -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateIdClient" name="id_client" onchange="reloadListHost('policyCreateIdHost', this.value)" required>
                                    <option value="" disabled selected>Choose the Client</option>
                                    {% for c in clients %}
                                        <option value="{{ c.id_client }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <label for="policyCreateIdClient">Client</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateIdHost" name="id_host" onchange="reloadListDatabase('policyCreateIdDatabase', policyCreateIdClient.value, this.value)" required>
                                    <option value="" disabled selected>Choose client first</option>
                                </select>
                                <label for="policyCreateIdHost">Host</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateIdDatabase" name="id_database" required>
                                    <option value="" disabled selected>Choose host first</option>
                                </select>
                                <label for="policyCreateIdDatabase">Database</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup Configuration -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateBackupType" name="backup_type" required>
                                    <option value="" disabled selected>Choose Backup Type</option>
                                    <option value="ARCHIVELOG">ARCHIVELOG</option>
                                    <option value="DB FULL">DB FULL</option>
                                    <option value="DB INCR">DB INCR</option>
                                    <option value="RECVR AREA">RECVR AREA</option>
                                    <option value="BACKUPSET">BACKUPSET</option>
                                </select>
                                <label for="policyCreateBackupType">Backup Type</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="policyCreateDestination" name="destination" required>
                                    <option value="" disabled selected>Choose Destination</option>
                                    <option value="SBT_TAPE">SBT_TAPE</option>
                                    <option value="DISK">DISK</option>
                                </select>
                                <label for="policyCreateDestination">Destination</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Estimates -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="policyCreateSizeBackup" name="size_backup" step="0.01" required>
                                <label for="policyCreateSizeBackup">Estimated Size (GB)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="policyCreateDuration" name="duration" required>
                                <label for="policyCreateDuration">Duration (minutes)</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CRON Schedule -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>CRON Schedule Format:</strong> Use standard CRON syntax (* for all values)
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateMinute" name="minute" placeholder="*" required>
                                <label for="policyCreateMinute">Minute (0-59)</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateHour" name="hour" placeholder="*" required>
                                <label for="policyCreateHour">Hour (0-23)</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateDay" name="day" placeholder="*" required>
                                <label for="policyCreateDay">Day (1-31)</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateMonth" name="month" placeholder="*" required>
                                <label for="policyCreateMonth">Month (1-12)</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="policyCreateDayWeek" name="day_week" placeholder="*" required>
                                <label for="policyCreateDayWeek">Day of Week (0-7)</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="row mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <textarea class="form-control" id="policyCreateDescription" name="description" style="height: 80px"></textarea>
                                <label for="policyCreateDescription">Description</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-modern btn-modern-primary">
                        <i class="bi bi-save me-2"></i>Create Policy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals for View, Edit, Delete (simplified for now) -->
<div class="modal fade" id="policyModalDetail" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header modern-card-header">
                <h5 class="modal-title" id="policyDetailTitle"><i class="bi bi-eye me-2"></i>Policy Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modern-card-body">
                <div id="policyDetailList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="policyModalUpdate" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content modal-modern">
            <div class="modal-header modern-card-header">
                <h5 class="modal-title" id="policyUpdateTitle"><i class="bi bi-pencil me-2"></i>Edit Policy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modern-card-body">
                <!-- Form content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="policyModalDelete" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modern-card-body">
                <div class="alert alert-modern alert-modern-danger text-center">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Warning!</h5>
                    <p class="mb-0">This action cannot be undone. The backup policy will be permanently deleted.</p>
                </div>
                <p class="text-center mt-3">Do you really want to delete the policy: <strong id="deletePolicyName"></strong>?</p>
            </div>
            <form id="policyFormDelete">
                <div class="modal-footer">
                    {% csrf_token %}
                    <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-modern btn-modern-danger">
                        <i class="bi bi-trash me-2"></i>Delete Policy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// Função para mostrar mensagens
function showMessage(message, type = 'success') {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-modern-success' : 'alert-modern-danger';
    
    messageContainer.innerHTML = `
        <div class="alert alert-modern ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    setTimeout(() => {
        const alert = messageContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Create Policy
$(document).ready(function() {
    $('#policyFormCreate').submit(function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var data = form.serialize();
        
        $.ajax({
            url: url,
            type: 'POST',
            data: data,
            success: function(response) {
                showMessage('Policy created successfully!', 'success');
                $('#modalAddNew').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    showMessage(response.error || 'Error creating policy', 'error');
                } catch (e) {
                    showMessage('Internal server error', 'error');
                }
            }
        });
    });
});

function reloadListHost(elemSelectId, idClient, callback = null) {
    $.ajax({
        url: '{% url "coreRelback:databaseHostsList" %}',
        type: 'GET',
        data: { 'id_client': idClient },
        dataType: 'json',
        success: function(data) {
            const selectHosts = document.getElementById(elemSelectId);
            selectHosts.innerHTML = "";
            
            const optPlaceHolder = document.createElement("option");
            optPlaceHolder.text = "Choose a host";
            optPlaceHolder.value = "";
            optPlaceHolder.disabled = true;
            optPlaceHolder.selected = true;
            selectHosts.appendChild(optPlaceHolder);
            
            if (data.hosts) {
                const hosts = JSON.parse(data.hosts);
                hosts.forEach(function(host) {
                    const opt = document.createElement("option");
                    opt.text = host.fields.hostname;
                    opt.value = host.pk;
                    selectHosts.appendChild(opt);
                });
            }
            if (callback) callback();
        },
        error: function(xhr, errmsg, err) {
            console.log("Error loading host list: " + xhr.responseText);
            showMessage('Error loading hosts for client', 'error');
        }
    });
}

function reloadListDatabase(elemSelectId, idClient, idHost, callback = null) {
    $.ajax({
        url: '{% url "coreRelback:policyDatabasesList" %}',
        type: 'GET',
        data: { 'id_client': idClient, 'id_host': idHost },
        dataType: 'json',
        success: function(data) {
            const selectDatabases = document.getElementById(elemSelectId);
            selectDatabases.innerHTML = "";
            
            const optPlaceHolder = document.createElement("option");
            optPlaceHolder.text = "Choose a database";
            optPlaceHolder.value = "";
            optPlaceHolder.disabled = true;
            optPlaceHolder.selected = true;
            selectDatabases.appendChild(optPlaceHolder);
            
            if (data.databases) {
                const databases = JSON.parse(data.databases);
                databases.forEach(function(db) {
                    const opt = document.createElement("option");
                    opt.text = db.fields.db_name;
                    opt.value = db.pk;
                    selectDatabases.appendChild(opt);
                });
            }
            if (callback) callback();
        },
        error: function(xhr, errmsg, err) {
            console.log("Error loading database list: " + xhr.responseText);
            showMessage('Error loading databases for host', 'error');
        }
    });
}

function policyDetail(id_policy) {
    // Implementation for policy details
    $('#policyModalDetail').modal('show');
}

function policyUpdate(id_policy) {
    // Implementation for policy update
    $('#policyModalUpdate').modal('show');
}

function policyModalDelete(id_policy) {
    const tr = $("#policy-" + id_policy);
    const policyName = tr.find(".policyName").text();

    $('#deletePolicyName').text(policyName);
    $('#policyModalDelete').modal('show');
}

// Reset forms when modals are hidden
$('.modal').on('hidden.bs.modal', function() {
    $(this).find('form')[0].reset();
    $('#policyCreateIdHost, #policyCreateIdDatabase').html('<option value="" disabled selected>Choose client first</option>');
});
</script>
{% endblock %}
