{% extends 'base.html' %}
{% load static %}

{% block title %}Databases - RelBack{% endblock %}

{% block content %}
<div class="md-container-fluid">
    <!-- Page Header -->
    <div class="md-grid md-grid-cols-1 md-mb-5">
        <div class="md-card md-p-5">
            <div class="md-flex md-items-center md-justify-between">
                <div class="md-flex md-items-center">
                    <i class="material-icons md-me-3" style="font-size: 56px; color: var(--md-primary);">storage</i>
                    <div>
                        <h1 class="h2 md-mb-1">Database Management</h1>
                        <p class="md-text-muted md-mb-0" style="font-size: 1.1rem;">Manage your database backup configurations</p>
                    </div>
                </div>
                <a href="{% url 'coreRelback:database-create' %}" class="md-btn md-btn-primary" style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                    <i class="material-icons md-me-1">add</i>
                    Add Database
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="md-grid md-grid-cols-4 md-mb-5">
        <div class="md-card oracle-card-gradient" style="background: linear-gradient(to bottom, #3C4545, #697778) !important; color: white !important; padding: var(--spacing-xl); min-height: 140px;">
            <div class="md-flex md-items-center md-justify-between">
                <div>
                    <h2 class="h3 md-mb-1">{{ databases.count }}</h2>
                    <p class="md-mb-0 h6" style="opacity: 0.75;">Total Databases</p>
                </div>
                <i class="material-icons" style="font-size: 3rem; opacity: 0.8;">storage</i>
            </div>
        </div>
        <div class="md-card oracle-card-gradient" style="background: linear-gradient(to bottom, #3C4545, #697778) !important; color: white !important; padding: var(--spacing-xl); min-height: 140px;">
            <div class="md-flex md-items-center md-justify-between">
                <div>
                    <h2 class="h3 md-mb-1">{{ active_databases|default:0 }}</h2>
                    <p class="md-mb-0 h6" style="opacity: 0.75;">Active Databases</p>
                </div>
                <i class="material-icons" style="font-size: 3rem; opacity: 0.8;">check_circle</i>
            </div>
        </div>
        <div class="md-card oracle-card-gradient" style="background: linear-gradient(to bottom, #3C4545, #697778) !important; color: white !important; padding: var(--spacing-xl); min-height: 140px;">
            <div class="md-flex md-items-center md-justify-between">
                <div>
                    <h2 class="h3 md-mb-1">{{ oracle_databases|default:0 }}</h2>
                    <p class="md-mb-0 h6" style="opacity: 0.75;">Oracle Databases</p>
                </div>
                <i class="material-icons" style="font-size: 3rem; opacity: 0.8;">account_tree</i>
            </div>
        </div>
        <div class="md-card oracle-card-gradient" style="background: linear-gradient(to bottom, #3C4545, #697778) !important; color: white !important; padding: var(--spacing-xl); min-height: 140px;">
            <div class="md-flex md-items-center md-justify-between">
                <div>
                    <h2 class="h3 md-mb-1">{{ backed_up_today|default:0 }}</h2>
                    <p class="md-mb-0 h6" style="opacity: 0.75;">Backed Up Today</p>
                </div>
                <i class="material-icons" style="font-size: 3rem; opacity: 0.8;">backup</i>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="md-grid md-grid-cols-1 md-mb-5">
        <div class="md-card md-p-4">
            <div class="md-grid md-grid-cols-5 md-gap-4 md-items-center">
                <div class="md-input-group">
                    <input type="text" class="md-input" id="searchDatabase" placeholder="Search databases...">
                    <label class="md-label">Search databases...</label>
                </div>
                <div class="md-input-group">
                    <select class="md-select" id="filterHost">
                        <option value="">All Hosts</option>
                        {% for host in hosts %}
                        <option value="{{ host.name }}">{{ host.name }}</option>
                        {% endfor %}
                    </select>
                    <label class="md-label">Host</label>
                </div>
                <div class="md-input-group">
                    <select class="md-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="Oracle">Oracle</option>
                        <option value="MySQL">MySQL</option>
                        <option value="PostgreSQL">PostgreSQL</option>
                    </select>
                    <label class="md-label">Type</label>
                </div>
                <button class="md-btn md-btn-outlined md-w-full" style="padding: 0.75rem 1.2rem; font-size: 1rem;">
                    <i class="material-icons md-me-1">filter_list</i>
                    More Filters
                </button>
                <button class="md-btn md-btn-text md-w-full" style="padding: 0.75rem 1.2rem; font-size: 1rem;">
                    <i class="material-icons md-me-1">refresh</i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
    <!-- Databases Table -->
    <div class="md-grid md-grid-cols-1">
        <div class="md-card">
            <div class="md-table-responsive">
                <table class="md-table" id="databasesTable">
                    <thead>
                        <tr>
                            <th class="md-ps-4">
                                <i class="material-icons md-me-2">storage</i>
                                Database
                            </th>
                            <th>
                                <i class="material-icons md-me-2">dns</i>
                                Host
                            </th>
                            <th>
                                <i class="material-icons md-me-2">category</i>
                                Type
                            </th>
                            <th>
                                <i class="material-icons md-me-2">folder</i>
                                Size
                            </th>
                            <th>
                                <i class="material-icons md-me-2">schedule</i>
                                Last Backup
                            </th>
                            <th>
                                <i class="material-icons md-me-2">settings</i>
                                Status
                            </th>
                            <th class="md-text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for database in databases %}
                        <tr class="database-row" 
                            data-host="{{ database.host.name|default:'Unknown' }}" 
                            data-type="{{ database.db_type|default:'Unknown' }}"
                            data-status="{% if database.active %}active{% else %}inactive{% endif %}"
                            data-backup="{% if database.last_backup_date %}{% with now_timestamp=now|date:'U'|add:'-604800' backup_timestamp=database.last_backup_date|date:'U' %}{% if backup_timestamp > now_timestamp %}recent{% else %}old{% endif %}{% endwith %}{% else %}none{% endif %}">
                            <td class="md-ps-4">
                                <div class="md-flex md-items-center">
                                    <div class="md-avatar md-avatar-md md-me-3">
                                        {% if 'oracle' in database.db_type|lower %}
                                            <i class="material-icons" style="color: #ea4335;">developer_board</i>
                                        {% elif 'mysql' in database.db_type|lower %}
                                            <i class="material-icons" style="color: #fbbc04;">storage</i>
                                        {% elif 'postgres' in database.db_type|lower %}
                                            <i class="material-icons" style="color: #4285f4;">account_tree</i>
                                        {% elif 'sql' in database.db_type|lower %}
                                            <i class="material-icons" style="color: #4285f4;">view_module</i>
                                        {% else %}
                                            <i class="material-icons" style="color: #9aa0a6;">storage</i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ database.name }}</strong>
                                        {% if database.description %}
                                        <br><small class="md-text-muted">{{ database.description|truncatechars:40 }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if database.host %}
                                <div class="md-flex md-items-center">
                                    <div class="md-status-dot {% if database.host.active %}md-status-success{% else %}md-status-secondary{% endif %} md-me-2"></div>
                                    <span>{{ database.host.name }}</span>
                                </div>
                                {% else %}
                                <span class="md-text-muted">No Host</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if database.db_type %}
                                <span class="md-chip md-chip-secondary">{{ database.db_type }}</span>
                                {% else %}
                                <span class="md-text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if database.size %}
                                <span class="md-text-nowrap">{{ database.size|filesizeformat }}</span>
                                {% else %}
                                <span class="md-text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if database.last_backup_date %}
                                <div>
                                    <small>{{ database.last_backup_date|date:"M d, Y" }}</small>
                                    <br>
                                    {% with now_timestamp=now|date:'U'|add:'-604800' backup_timestamp=database.last_backup_date|date:'U' %}
                                    {% if backup_timestamp > now_timestamp %}
                                        <span class="md-chip md-chip-success">Recent</span>
                                    {% else %}
                                        <span class="md-chip md-chip-warning">Outdated</span>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                {% else %}
                                <span class="md-chip md-chip-danger">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if database.active %}
                                <span class="md-chip md-chip-success">
                                    <i class="material-icons md-me-1" style="font-size: 12px;">check_circle</i>
                                    Active
                                </span>
                                {% else %}
                                <span class="md-chip md-chip-secondary">
                                    <i class="material-icons md-me-1" style="font-size: 12px;">pause_circle</i>
                                    Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td class="md-text-center">
                                <div class="md-btn-group">
                                    <a href="{% url 'coreRelback:database-detail' database.id_database %}" 
                                       class="md-btn md-btn-sm md-btn-outlined" 
                                       title="View Details">
                                        <i class="material-icons">visibility</i>
                                    </a>
                                    <a href="{% url 'coreRelback:database-update' database.id_database %}" 
                                       class="md-btn md-btn-sm md-btn-outlined" 
                                       title="Edit">
                                        <i class="material-icons">edit</i>
                                    </a>
                                    <button class="md-btn md-btn-sm md-btn-outlined" 
                                            title="Refresh Data"
                                            onclick="refreshDatabase('{{ database.id_database }}', '{{ database.db_name }}')">
                                        <i class="material-icons">refresh</i>
                                    </button>
                                    <a href="{% url 'coreRelback:database-delete' database.id_database %}" 
                                       class="md-btn md-btn-sm md-btn-danger" 
                                       title="Delete">
                                        <i class="material-icons">delete</i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="md-text-center md-py-5">
                                <div class="md-empty-state">
                                    <i class="material-icons md-mb-3" style="font-size: 64px; color: #ccc;">storage</i>
                                    <h5 class="md-text-muted">No databases found</h5>
                                    <p class="md-text-muted">Start by adding your first database configuration.</p>
                                    <a href="{% url 'coreRelback:database-create' %}" class="md-btn md-btn-primary">
                                        <i class="material-icons md-me-1">add</i>
                                        Add First Database
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="md-fab" id="addDatabaseFab" title="Add New Database">
    <i class="material-icons">add</i>
</button>

<!-- Material Design Modal -->
<div class="md-modal" id="backupModal">
    <div class="md-modal-backdrop" onclick="closeModal('backupModal')"></div>
    <div class="md-modal-content">
        <div class="md-modal-header">
            <h5 class="md-modal-title">
                <i class="material-icons md-me-2">backup</i>
                Database Backup
            </h5>
            <button type="button" class="md-modal-close" onclick="closeModal('backupModal')">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="md-modal-body">
            <div class="md-text-center">
                <div class="md-spinner md-mb-3"></div>
                <h6 id="backupDatabaseName">Database Name</h6>
                <p class="md-text-muted">Backup in progress, please wait...</p>
            </div>
        </div>
    </div>
</div>

<script>
// FAB click handler
document.getElementById('addDatabaseFab').addEventListener('click', function() {
    window.location.href = '{% url "coreRelback:database-create" %}';
});

// Search functionality
document.getElementById('searchDatabase').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr.database-row');
    
    tableRows.forEach(row => {
        const databaseName = row.querySelector('strong').textContent.toLowerCase();
        const hostName = row.dataset.host.toLowerCase();
        const dbType = row.dataset.type.toLowerCase();
        
        if (databaseName.includes(searchTerm) || hostName.includes(searchTerm) || dbType.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filter functionality
['filterHost', 'filterType', 'filterStatus', 'filterBackup'].forEach(filterId => {
    const filterElement = document.getElementById(filterId);
    if (filterElement) {
        filterElement.addEventListener('change', function() {
            applyFilters();
        });
    }
});

function applyFilters() {
    const hostFilter = document.getElementById('filterHost').value;
    const typeFilter = document.getElementById('filterType').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const backupFilter = document.getElementById('filterBackup').value;
    
    const tableRows = document.querySelectorAll('tbody tr.database-row');
    
    tableRows.forEach(row => {
        let show = true;
        
        if (hostFilter && row.dataset.host !== hostFilter) show = false;
        if (typeFilter && !row.dataset.type.toLowerCase().includes(typeFilter.toLowerCase())) show = false;
        if (statusFilter && row.dataset.status !== statusFilter) show = false;
        if (backupFilter && row.dataset.backup !== backupFilter) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// Refresh database function
function refreshDatabase(databaseId, databaseName) {
    document.getElementById('backupDatabaseName').textContent = databaseName;
    openModal('backupModal');
    
    // Simulate backup process
    setTimeout(() => {
        closeModal('backupModal');
        showSnackbar('Database refreshed successfully!', 'success');
    }, 3000);
}

// Modal functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('md-modal-open');
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('md-modal-open');
}

// Snackbar function
function showSnackbar(message, type = 'info') {
    const snackbar = document.createElement('div');
    snackbar.className = `md-snackbar md-snackbar-${type}`;
    snackbar.innerHTML = `
        <div class="md-snackbar-content">
            <i class="material-icons md-snackbar-icon">${type === 'success' ? 'check_circle' : 'info'}</i>
            <span class="md-snackbar-message">${message}</span>
        </div>
        <button type="button" class="md-snackbar-close" onclick="this.parentElement.remove()">
            <i class="material-icons">close</i>
        </button>
    `;
    
    document.body.appendChild(snackbar);
    
    setTimeout(() => {
        if (snackbar.parentElement) {
            snackbar.remove();
        }
    }, 5000);
}

// Material Design interactions
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards on load
    const cards = document.querySelectorAll('.md-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('tbody tr.database-row');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(66, 133, 244, 0.08)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>
{% endblock %}
