{% extends 'base.html' %}
{% load static %}

{% block title %}RelBack - Databases{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="page-title">Gerenciar Databases</h1>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ databases|length }}</div>
                <div class="stats-label">Total de Databases</div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="modern-card">
                <div class="modern-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Sistema de Gestão de Databases Oracle</h5>
                            <p class="text-muted mb-0">Monitore e gerencie bancos de dados Oracle do sistema RelBack</p>
                        </div>
                        <button type="button" class="btn btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#modalAddNew">
                            <i class="bi bi-plus-circle-fill me-2"></i>Nova Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer"></div>

    <!-- Databases Table -->
    <div class="modern-card">
        <div class="modern-card-body">
            <div class="table-responsive">
                <table class="table table-modern" id="databaseTable">
                    <thead>
                        <tr>
                            <th><i class="bi bi-building me-2"></i>Cliente</th>
                            <th><i class="bi bi-server me-2"></i>Host</th>
                            <th><i class="bi bi-database me-2"></i>DB_NAME</th>
                            <th><i class="bi bi-hash me-2"></i>DBID</th>
                            <th><i class="bi bi-file-text me-2"></i>Descrição</th>
                            <th class="text-center"><i class="bi bi-gear me-2"></i>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in databases %}
                        <tr id="database-{{ d.id_database }}">
                            <td class="databaseClientName fw-bold">{{ d.id_client.name }}</td>
                            <input type="hidden" class="databaseClientId" value="{{ d.id_client.id_client }}">
                            <td class="databaseHostname">{{ d.id_host.hostname }}</td>
                            <input type="hidden" class="databaseHostId" value="{{ d.id_host.id_host }}">
                            <td class="databaseDbName">
                                {{ d.db_name }}
                                <span class="badge badge-modern badge-modern-success ms-2">Oracle</span>
                            </td>
                            <td class="databaseDbId">{{ d.dbid }}</td>
                            <td class="databaseDescription">{{ d.description|default:"Sem descrição" }}</td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <button class="btn-action btn-action-edit btn-edit" data-id="{{ d.id_database }}" title="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn-action btn-action-delete btn-delete" data-id="{{ d.id_database }}" title="Excluir">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="bi bi-database"></i>
                                </div>
                                <div class="empty-state-title">Nenhuma database cadastrada</div>
                                <div class="empty-state-description">Clique em "Nova Database" para adicionar a primeira database.</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add New Database -->
<div class="modal fade" id="modalAddNew" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content neo-modal">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Nova Database</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="databaseFormCreate">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="databaseCreateIdClient" class="form-label fw-bold">Cliente *</label>
                            <select class="neo-select" id="databaseCreateIdClient" name="id_client" required>
                                <option value="" disabled selected>Escolha o Cliente</option>
                                {% for c in clients %}
                                    <option value="{{ c.id_client }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="databaseCreateIdHost" class="form-label fw-bold">Host *</label>
                            <select class="neo-select" id="databaseCreateIdHost" name="id_host" required>
                                <option value="" disabled selected>Primeiro escolha o cliente</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="databaseCreateDbName" class="form-label fw-bold">DB_NAME *</label>
                            <input type="text" class="neo-input" id="databaseCreateDbName" name="db_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="databaseCreateDbId" class="form-label fw-bold">DBID *</label>
                            <input type="text" class="neo-input" id="databaseCreateDbId" name="dbid" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="databaseCreateDescription" class="form-label fw-bold">Descrição</label>
                        <textarea class="neo-input" id="databaseCreateDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-button" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="neo-button neo-button-primary">
                        <i class="bi bi-check-circle me-2"></i>Criar Database
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Update Database -->
<div class="modal fade" id="databaseModalUpdate" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content neo-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="databaseUpdateTitle"><i class="bi bi-pencil me-2"></i>Editar Database</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="databaseFormUpdate">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" id="databaseUpdateIdDatabase" name="id_database">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="databaseUpdateClient" class="form-label fw-bold">Cliente *</label>
                            <select class="neo-select" id="databaseUpdateClient" name="id_client" required>
                                <option value="" disabled>Escolha o Cliente</option>
                                {% for c in clients %}
                                    <option value="{{ c.id_client }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="databaseUpdateHost" class="form-label fw-bold">Host *</label>
                            <select class="neo-select" id="databaseUpdateHost" name="id_host" required>
                                <option value="" disabled>Escolha o Host</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="databaseUpdateDbName" class="form-label fw-bold">DB_NAME *</label>
                            <input type="text" class="neo-input" id="databaseUpdateDbName" name="db_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="databaseUpdateDbId" class="form-label fw-bold">DBID *</label>
                            <input type="text" class="neo-input" id="databaseUpdateDbId" name="dbid" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="databaseUpdateDescription" class="form-label fw-bold">Descrição</label>
                        <textarea class="neo-input" id="databaseUpdateDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-button" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="neo-button neo-button-primary">
                        <i class="bi bi-check-circle me-2"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Delete Database -->
<div class="modal fade" id="databaseModalDelete" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content neo-modal">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert-neo text-center">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--danger);"></i>
                    <h5 class="mt-3">Atenção!</h5>
                    <p class="mb-0">Esta ação não pode ser desfeita. Ao excluir a database, todas as políticas de backup relacionadas também serão removidas.</p>
                </div>
                <p class="text-center mt-3">Deseja realmente excluir a database: <strong id="deleteDbName"></strong>?</p>
            </div>
            <form id="databaseFormDelete">
                <div class="modal-footer">
                    {% csrf_token %}
                    <button type="button" class="neo-button" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="neo-button neo-button-danger">
                        <i class="bi bi-trash me-2"></i>Confirmar Exclusão
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// Função para mostrar mensagens
function showMessage(message, type = 'success') {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    
    messageContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show alert-neo" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    setTimeout(() => {
        const alert = messageContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Edit button handlers
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            databaseUpdate(id);
        });
    });

    // Delete button handlers
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            databaseModalDelete(id);
        });
    });

    // Client selection change handler
    document.getElementById('databaseCreateIdClient').addEventListener('change', function() {
        reloadHostList('databaseCreateIdHost', this.value);
    });

    document.getElementById('databaseUpdateClient').addEventListener('change', function() {
        reloadHostList('databaseUpdateHost', this.value);
    });
});

// Create Database
$("#databaseFormCreate").submit(function(e) {
    e.preventDefault();
    
    $.ajax({
        url: '{% url "coreRelback:databaseCreate" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'id_client': $('#databaseCreateIdClient').val(),
            'id_host': $('#databaseCreateIdHost').val(),
            'db_name': $('#databaseCreateDbName').val(),
            'db_id': $('#databaseCreateDbId').val(),
            'description': $('#databaseCreateDescription').val(),
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Database criada com sucesso!', 'success');
                $("#modalAddNew").modal('hide');
                location.reload();
            } else {
                showMessage(data.error || 'Erro ao criar database', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

// Update Database
$("#databaseFormUpdate").submit(function(e) {
    e.preventDefault();
    
    $.ajax({
        url: '{% url "coreRelback:databaseUpdate" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'id_database': $('#databaseUpdateIdDatabase').val(),
            'id_client': $('#databaseUpdateClient').val(),
            'id_host': $('#databaseUpdateHost').val(),
            'db_name': $('#databaseUpdateDbName').val(),
            'db_id': $('#databaseUpdateDbId').val(),
            'description': $('#databaseUpdateDescription').val(),
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Database atualizada com sucesso!', 'success');
                $("#databaseModalUpdate").modal('hide');
                location.reload();
            } else {
                showMessage(data.error || 'Erro ao atualizar database', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

// Delete Database
$("#databaseFormDelete").submit(function(e) {
    e.preventDefault();
    
    const databaseId = $('#databaseUpdateIdDatabase').val();
    
    $.ajax({
        url: '{% url "coreRelback:databaseDelete" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'id_database': databaseId,
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Database excluída com sucesso!', 'success');
                $("#databaseModalDelete").modal('hide');
                $("#database-" + databaseId).remove();
                
                if ($("#databaseTable tbody tr").length === 0) {
                    location.reload();
                }
            } else {
                showMessage(data.error || 'Erro ao excluir database', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

function databaseUpdate(id_database) {
    const tr = $("#database-" + id_database);
    const clientName = tr.find(".databaseClientName").text();
    const clientId = tr.find(".databaseClientId").val();
    const hostname = tr.find(".databaseHostname").text();
    const hostId = tr.find(".databaseHostId").val();
    const dbName = tr.find(".databaseDbName").text().replace('Oracle', '').trim();
    const dbId = tr.find(".databaseDbId").text();
    const description = tr.find(".databaseDescription").text();

    $('#databaseUpdateTitle').html('<i class="bi bi-pencil me-2"></i>Editar Database: ' + dbName);
    $('#databaseUpdateIdDatabase').val(id_database);
    $('#databaseUpdateClient').val(clientId);
    
    reloadHostList('databaseUpdateHost', clientId, function() {
        $('#databaseUpdateHost').val(hostId);
    });
    
    $('#databaseUpdateDbName').val(dbName);
    $('#databaseUpdateDbId').val(dbId);
    $('#databaseUpdateDescription').val(description === 'Sem descrição' ? '' : description);
    
    $('#databaseModalUpdate').modal('show');
}

function databaseModalDelete(id_database) {
    const tr = $("#database-" + id_database);
    const dbName = tr.find(".databaseDbName").text().replace('Oracle', '').trim();

    $('#deleteDbName').text(dbName);
    $('#databaseUpdateIdDatabase').val(id_database);
    
    $('#databaseModalDelete').modal('show');
}

// Reload host list based on client selection
function reloadHostList(elemSelectId, idClient, callback = null) {
    $.ajax({
        url: '{% url "coreRelback:databaseHostsList" %}',
        type: 'GET',
        data: { 'id_client': idClient },
        dataType: 'json',
        success: function(data) {
            const selectHosts = document.getElementById(elemSelectId);
            selectHosts.innerHTML = "";
            
            const optPlaceHolder = document.createElement("option");
            optPlaceHolder.text = "Escolha um host";
            optPlaceHolder.value = "";
            optPlaceHolder.disabled = true;
            optPlaceHolder.selected = true;
            selectHosts.appendChild(optPlaceHolder);

            if (data.hosts) {
                const hosts = JSON.parse(data.hosts);
                hosts.forEach(function(host) {
                    const opt = document.createElement("option");
                    opt.text = host.fields.hostname;
                    opt.value = host.pk;
                    selectHosts.appendChild(opt);
                });
            }
            
            if (callback) callback();
        },
        error: function(xhr, errmsg, err) {
            console.log("Erro ao carregar lista de hosts: " + xhr.responseText);
            showMessage('Erro ao carregar hosts do cliente', 'error');
        }
    });
}

// Reset forms when modals are hidden
$('.modal').on('hidden.bs.modal', function() {
    $(this).find('form')[0].reset();
    $('#databaseCreateIdHost, #databaseUpdateHost').html('<option value="" disabled selected>Primeiro escolha o cliente</option>');
});
</script>
{% endblock %}
