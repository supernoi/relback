{% extends 'base.html' %}
{% load static %}

{% block title %}RelBack - Hosts{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="page-title">Gerenciar Hosts</h1>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ hosts|length }}</div>
                <div class="stats-label">Total de Hosts</div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="modern-card">
                <div class="modern-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Sistema de Gestão de Hosts</h5>
                            <p class="text-muted mb-0">Cadastre e gerencie servidores do sistema RelBack</p>
                        </div>
                        <button type="button" class="btn btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#modalAddNew">
                            <i class="bi bi-plus-circle-fill me-2"></i>Novo Host
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer"></div>

    <!-- Hosts Table -->
    <div class="modern-card">
        <div class="modern-card-body">
            <div class="table-responsive">
                <table class="table table-modern" id="hostTable">
                    <thead>
                        <tr>
                            <th><i class="bi bi-hash me-2"></i>ID</th>
                            <th><i class="bi bi-server me-2"></i>Nome</th>
                            <th><i class="bi bi-diagram-3 me-2"></i>Endereço</th>
                            <th><i class="bi bi-building me-2"></i>Cliente</th>
                            <th class="text-center"><i class="bi bi-gear me-2"></i>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in hosts %}
                        <tr id="host-{{ h.id_host }}">
                            <td class="hostId fw-bold">{{ h.id_host }}</td>
                            <td class="hostName">{{ h.hostname }}</td>
                            <td class="hostAddress">{{ h.ip }}</td>
                            <td class="hostClient">{{ h.client.name|default:"N/A" }}</td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <button class="btn-action btn-action-edit" onclick="hostUpdate({{ h.id_host }})" title="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn-action btn-action-delete" onclick="hostModalDelete({{ h.id_host }})" title="Excluir">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="bi bi-server"></i>
                                </div>
                                <div class="empty-state-title">Nenhum host cadastrado</div>
                                <div class="empty-state-description">Clique em "Novo Host" para adicionar o primeiro servidor.</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add New Host -->
<div class="modal fade" id="modalAddNew" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header modern-card-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Novo Host</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="hostFormCreate">
                <div class="modal-body modern-card-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="hostCreateName" class="form-label">Nome *</label>
                        <input type="text" class="form-control form-control-modern" id="hostCreateName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="hostCreateAddress" class="form-label">Endereço *</label>
                        <input type="text" class="form-control form-control-modern" id="hostCreateAddress" name="address" required>
                        <div class="form-text">Ex: 192.168.1.100 ou hostname.domain.com</div>
                    </div>
                    <div class="mb-3">
                        <label for="hostCreateClient" class="form-label">Cliente *</label>
                        <select class="form-select form-control-modern" id="hostCreateClient" name="client" required>
                            <option value="">Selecione um cliente</option>
                            {% for client in clients %}
                            <option value="{{ client.id_client }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-modern btn-modern-primary">
                        <i class="bi bi-check-circle me-2"></i>Criar Host
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Update Host -->
<div class="modal fade" id="hostModalUpdate" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header modern-card-header">
                <h5 class="modal-title" id="hostUpdateTitle"><i class="bi bi-pencil me-2"></i>Editar Host</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="hostFormUpdate">
                <div class="modal-body modern-card-body">
                    {% csrf_token %}
                    <input type="hidden" id="hostUpdateIdHost" name="id_host">
                    <div class="mb-3">
                        <label for="hostUpdateName" class="form-label">Nome *</label>
                        <input type="text" class="form-control form-control-modern" id="hostUpdateName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="hostUpdateAddress" class="form-label">Endereço *</label>
                        <input type="text" class="form-control form-control-modern" id="hostUpdateAddress" name="address" required>
                        <div class="form-text">Ex: 192.168.1.100 ou hostname.domain.com</div>
                    </div>
                    <div class="mb-3">
                        <label for="hostUpdateClient" class="form-label">Cliente *</label>
                        <select class="form-select form-control-modern" id="hostUpdateClient" name="client" required>
                            <option value="">Selecione um cliente</option>
                            {% for client in clients %}
                            <option value="{{ client.id_client }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-modern btn-modern-primary">
                        <i class="bi bi-check-circle me-2"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Delete Host -->
<div class="modal fade" id="hostModalDelete" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modern-card-body">
                <div class="alert alert-modern alert-modern-danger text-center">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Atenção!</h5>
                    <p class="mb-0">Esta ação não pode ser desfeita. Ao excluir o host, todos os databases e políticas relacionadas também serão removidos.</p>
                </div>
                <p class="text-center mt-3">Deseja realmente excluir o host: <strong id="deleteHostName"></strong>?</p>
            </div>
            <form id="hostFormDelete">
                <div class="modal-footer">
                    {% csrf_token %}
                    <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-modern btn-modern-danger">
                        <i class="bi bi-trash me-2"></i>Confirmar Exclusão
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// Função para mostrar mensagens
function showMessage(message, type = 'success') {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-modern-success' : 'alert-modern-danger';
    
    messageContainer.innerHTML = `
        <div class="alert alert-modern ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        const alert = messageContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Create Host
$("#hostFormCreate").submit(function(e) {
    e.preventDefault();
    
    $.ajax({
        url: '{% url "coreRelback:hostCreate" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'name': $('#hostCreateName').val(),
            'address': $('#hostCreateAddress').val(),
            'client': $('#hostCreateClient').val(),
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Host criado com sucesso!', 'success');
                $("#modalAddNew").modal('hide');
                location.reload();
            } else {
                showMessage(data.error || 'Erro ao criar host', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

// Update Host
$("#hostFormUpdate").submit(function(e) {
    e.preventDefault();
    
    $.ajax({
        url: '{% url "coreRelback:hostUpdate" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'id_host': $('#hostUpdateIdHost').val(),
            'name': $('#hostUpdateName').val(),
            'address': $('#hostUpdateAddress').val(),
            'client': $('#hostUpdateClient').val(),
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Host atualizado com sucesso!', 'success');
                $("#hostModalUpdate").modal('hide');
                location.reload();
            } else {
                showMessage(data.error || 'Erro ao atualizar host', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

// Delete Host
$("#hostFormDelete").submit(function(e) {
    e.preventDefault();
    
    const hostId = $('#hostUpdateIdHost').val();
    
    $.ajax({
        url: '{% url "coreRelback:hostDelete" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        data: {
            'id_host': hostId,
        },
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                showMessage('Host excluído com sucesso!', 'success');
                $("#hostModalDelete").modal('hide');
                $("#host-" + hostId).remove();
                
                if ($("#hostTable tbody tr").length === 0) {
                    location.reload();
                }
            } else {
                showMessage(data.error || 'Erro ao excluir host', 'error');
            }
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showMessage(response.error || 'Erro interno do servidor', 'error');
            } catch (e) {
                showMessage('Erro interno do servidor', 'error');
            }
        }
    });
});

function hostUpdate(id_host) {
    const tr = $("#host-" + id_host);
    const hostName = tr.find(".hostName").text();
    const hostAddress = tr.find(".hostAddress").text();
    const hostClient = tr.find(".hostClient").text();

    $('#hostUpdateTitle').html('<i class="bi bi-pencil me-2"></i>Editar Host: ' + hostName);
    $('#hostUpdateIdHost').val(id_host);
    $('#hostUpdateName').val(hostName);
    $('#hostUpdateAddress').val(hostAddress);
    
    // Selecionar o cliente correto
    $("#hostUpdateClient option").each(function() {
        if ($(this).text() === hostClient) {
            $(this).prop('selected', true);
        }
    });
    
    $('#hostModalUpdate').modal('show');
}

function hostModalDelete(id_host) {
    const tr = $("#host-" + id_host);
    const hostName = tr.find(".hostName").text();

    $('#deleteHostName').text(hostName);
    $('#hostUpdateIdHost').val(id_host);
    
    $('#hostModalDelete').modal('show');
}

// Reset forms when modals are hidden
$('.modal').on('hidden.bs.modal', function() {
    $(this).find('form')[0].reset();
});
</script>
{% endblock %}
